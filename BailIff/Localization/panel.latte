<?php // vim: ts=4 sw=4 ai:
/**
 * This file is part of BailIff
 *
 * @copyright (c) 2010, 2011 Lopo <lopo@losys.eu>
 * @license http://www.gnu.org/licenses/gpl.html GNU General Public License Version 3
 */
/**
 * This file is part of the BailIff Framework.
 *
 * Copyright (c) 2006, 2011 Patrik Votoƒçek (http://patrik.votocek.cz)
 *
 * This source file is subject to the GNU Lesser General Public License. For more information please see http://bailiff-project.org
 */
/**
 * BailIff port
 * @author Lopo <lopo@losys.eu>
 */
?>
<h1>Translations for '<?php echo htmlspecialchars($lang) ?>'</h1>

<div class="nette-inner" id="bailiff-translator-panel-content">
	<p id="bailiff-translator-panel-notloaded">Data not loaded</p>
	<div id="bailiff-translator-panel-content-inner">
		<div id="bailiff-translator-panel-content-dictionary">
			<select id="bailiff-translator-panel-content-dictionaries-list"></select>
			<input type="text" class="text" id="bailiff-translator-panel-content-dictionaries-pluralform">
		</div>
		<div id="bailiff-translator-panel-content-sidebar">
			<!--<input type="text" class="text" id="bailiff-translator-panel-content-dictionaries-filter">
			<div id="bailiff-translator-panel-content-dictionaries-filter-reset"></div>-->
			<div id="bailiff-translator-panel-content-dictionary-translations">
				<p id="bailiff-translator-panel-forms-translations-empty">Empty</p>
			</div>
		</div>
		<div id="bailiff-translator-panel-content-editor">
			<p id="bailiff-translator-panel-content-forms-notset">Data not loaded (maybe missing jQuery)</p>
		</div>
		<br style="clear: both;">
		<div id="bailiff-translator-panel-content-actions">
			<input type="button" class="button" value="Reload" id="bailiff-translator-panel-content-actions-relaod">
			<input type="button" class="button" value="Extract" id="bailiff-translator-panel-content-actions-extract">
			<input type="button" class="button" value="Save" id="bailiff-translator-panel-content-actions-save">
		</div>
	</div>
</div>

<style>
	#bailiff-translator-panel-content {
		width: 460px;
		}
	#bailiff-translator-panel-content-inner {
		display: none;
		}
	#bailiff-translator-panel-content-dictionaries-list {
		width: 150px;
		border: 1px solid #ccc;
		}
	#bailiff-translator-panel-content-sidebar{
		margin: 0;
		padding: 0;
		width: 150px;
		float: left;
		border: 1px solid #eee;
		max-height: 400px;
		overflow: auto;
		}
	#bailiff-translator-panel-content-dictionary-translations span {
		display: block;
		border: 1px solid #ccc;
		padding: 2px;
		margin: 1px;
		}
	#bailiff-translator-panel-content-dictionary-translations span.saved {
		background-color: #efe;
		}
	#bailiff-translator-panel-content-dictionary-translations span.unsaved {
		background-color: #ffe;
		}
	#bailiff-translator-panel-content-dictionary-translations span.untranslated {
		background-color: #fee;
		}
	#bailiff-translator-panel-content-dictionaries-pluralform {
		width: 300px;
		border: 1px solid #ccc;
		}
	#bailiff-translator-panel-content-editor {
		margin: 5px;
		padding: 5px;
		width: 280px;
		float: right;
		overflow: auto;
		}
	#bailiff-translator-panel-content-editor textarea {
		width: 100%;
		display: block;
		margin-bottom: 5px;
		border: 1px solid #ccc;
		}
	#bailiff-translator-panel-content-actions {
		text-align: right;
		}
	#bailiff-translator-panel-content-actions input {
		background-color: #eee;
		padding: 2px;
		}
</style>

<script>
var BailIff= BailIff || {};

BailIff.translator={};

BailIff.translator.forms=function(pluralForm) {
	var pos=pluralForm.indexOf('=')+1;
	return pluralForm.substr(pos, pluralForm.indexOf(';')-pos);
	};

BailIff.translator.data=eval(<?php echo \Nette\Utils\Json::encode($dictionaries) ?>);
BailIff.translator.lang="<?php echo $lang ?>";

BailIff.translator.renderDictionaryList=function(dictionaries) {
	var $list=$('#bailiff-translator-panel-content-dictionaries-list');
	$list.html($('<option>').attr('value', 0).text('Select dictionary'));
	for (var i in dictionaries) {
		var $dictionary=$('<option>').attr('value', i).text(dictionaries[i]['name']);
		$dictionary.click(function() {
			var $this=$(this);
			BailIff.translator.loadDictionary($this.attr('value'));
			});
		$list.append($dictionary);
		}
	};

BailIff.translator.renderPluralForm=function(pluralForm) {
	var $input=$('#bailiff-translator-panel-content-dictionaries-pluralform');
	$input.val(pluralForm).attr('disabled', false);
	};

BailIff.translator.renderTranslationsList=function(translations) {
	var $list=$('#bailiff-translator-panel-content-dictionary-translations');
	$list.html(null);
	for (var i in translations) {
		var $translation=$('<span>').text(i);
		if (translations[i]['status']==true) {
			$translation.addClass('saved');
			}
		else if (translations[i]['status']==false) {
			$translation.addClass('unsaved');
			}
		else {
			$translation.addClass('untranslated');
			}

		$translation.click(function() {
			var dictionary=BailIff.translator.getActiveDictionary();
			if (!BailIff.translator.data[dictionary]['pluralForm']) {
				BailIff.translator.data[dictionary]['pluralForm']=$('#bailiff-translator-panel-content-dictionaries-pluralform').val();
				if (!BailIff.translator.data[dictionary]['pluralForm'] || !BailIff.translator.data[dictionary]['pluralForm'].indexOf('nplurals')) {
					alert('Please first set valid plural forms');
					$('#bailiff-translator-panel-content-dictionaries-pluralform')[0].focus();
					return false;
					}
				}
			var forms=BailIff.translator.forms(BailIff.translator.data[dictionary]['pluralForm']);
			BailIff.translator.renderEditor($(this).text(), forms, translations[$(this).text()]['translation']);
			});

		$list.append($translation);
		}
	};

BailIff.translator.renderEditor=function(message, forms, translations) {
	var $editor=$('#bailiff-translator-panel-content-editor');
	$editor.html(null);
	for (var i=0; i<forms; i++) {
		var text='';
		if (translations[i]) {
			text=translations[i];
			}
		$editor.append($('<textarea>').text(text).attr('data-bailiff-translator-message', message).attr('data-bailiff-translator-form', i).change(function() {
			var activeDictionary=BailIff.translator.getActiveDictionary();
			if (activeDictionary) {
				var $this=$(this);
				BailIff.translator.data[activeDictionary]['translations'][$this.attr('data-bailiff-translator-message')]['translation'][$this.attr('data-bailiff-translator-form')]=$this.val();
				BailIff.translator.data[activeDictionary]['translations'][$this.attr('data-bailiff-translator-message')]['status']=false;
				BailIff.translator.renderTranslationsList(BailIff.translator.data[activeDictionary]['translations']);
				}
			}));
		}
	};

BailIff.translator.loadDictionary=function(dictionary) {
	if (!BailIff.translator.data[dictionary]['pluralForm']) {
		BailIff.translator.data[dictionary]['pluralForm']=$('#bailiff-translator-panel-content-dictionaries-pluralform').val();
		}
	var data=BailIff.translator.data[dictionary];
	BailIff.translator.renderPluralForm(data['pluralForm']);
	BailIff.translator.renderTranslationsList(data['translations'])
	};

BailIff.translator.getActiveDictionary=function() {
	return $('#bailiff-translator-panel-content-dictionaries-list').val();
	};

BailIff.translator.renderProcessing=function() {
	$('#bailiff-translator-panel-content-editor').html(
		$('<p id="bailiff-translator-panel-content-forms-notset">Please select dictionary</p>')
		);

	$('#bailiff-translator-panel-content-dictionary-translations').html(
		$('<p id="bailiff-translator-panel-forms-translations-empty">Empty</p>')
		);
	$('#bailiff-translator-panel-content-dictionaries-list').val(0);
	};

if (!!window.jQuery) {
$(document).ready(function() {
	$('#bailiff-translator-panel-content-forms-notset').html('Data not loaded');
	//BailIff.translator.renderPluralForm();
	$('#bailiff-translator-panel-content-dictionaries-list').change(function() {
		var $this=$(this);
		if ($this.val()!=0) {
			BailIff.translator.loadDictionary($this.val());
			}
		});

	$('#bailiff-translator-panel-content-dictionaries-pluralform').change(function() {
		var activeDictionary=BailIff.translator.getActiveDictionary();
		if (activeDictionary) {
			BailIff.translator.data[activeDictionary]['pluralForm']=$(this).val();
			}
		});

	BailIff.translator.renderDictionaryList(BailIff.translator.data);
	$('#bailiff-translator-panel-content-inner').show();
	$('#bailiff-translator-panel-content-editor').html(
		$('<p id="bailiff-translator-panel-content-forms-notset">Please select dictionary</p>')
		);
	$('#bailiff-translator-panel-notloaded').hide();

	$('#bailiff-translator-panel-content-actions-relaod').click(function() {
		BailIff.translator.renderProcessing();
		jQuery.ajax({
			type: 'POST',
			url: window.location.href,
			data: { action: 'get', lang: BailIff.translator.lang},
			beforeSend: function(jqXHR) {
				jqXHR.setRequestHeader('<?php echo self::XHR_HEADER ?>', 'true');
				},
			success: function(data) {
				BailIff.translator.data=data.data;
				}
			});
		return false;
		});

	$('#bailiff-translator-panel-content-actions-extract').click(function() {
		BailIff.translator.renderProcessing();
		jQuery.ajax({
			type: 'POST',
			url: window.location.href,
			data: { action: 'extract', lang: BailIff.translator.lang},
			beforeSend: function(jqXHR) {
				jqXHR.setRequestHeader('<?php echo self::XHR_HEADER ?>', 'true');
				},
			success: function(data) {
				BailIff.translator.data=data.data;
				}
			});
		return false;
		});

	$('#bailiff-translator-panel-content-actions-save').click(function() {
		BailIff.translator.renderProcessing();
		jQuery.ajax({
			type: 'POST',
			url: window.location.href,
			data: { action: 'save', lang: BailIff.translator.lang, data: BailIff.translator.data},
			beforeSend: function(jqXHR) {
				jqXHR.setRequestHeader('<?php echo self::XHR_HEADER ?>', 'true');
				},
			success: function(data) {
				BailIff.translator.data=data.data;
				}
			});
		return false;
		});
	});
}
</script>